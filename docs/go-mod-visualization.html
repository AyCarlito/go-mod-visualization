<head>
  <style> body { margin: 0; } </style>

  <script src="https://cdn.jsdelivr.net/npm/force-graph"></script>
  <!--<script src="../../dist/force-graph.js"></script>-->
</head>

<body>
  <input type="text" id="searchInput" placeholder="Search dependencies" />
  <button id="searchButton">Search</button>
  <button id="resetButton">Reset</button>

  <div id="graph"></div>

  <script>
    const gData = {
      nodes: [
        {"id":"github.com/AyCarlito/go-mod-visualization", "group":1},
        {"id":"github.com/cpuguy83/go-md2man/v2@v2.0.4", "group":1},
        {"id":"github.com/davecgh/go-spew@v1.1.1", "group":1},
        {"id":"github.com/inconshreveable/mousetrap@v1.1.0", "group":1},
        {"id":"github.com/kr/text@v0.2.0", "group":1},
        {"id":"github.com/pmezard/go-difflib@v1.0.0", "group":1},
        {"id":"github.com/russross/blackfriday/v2@v2.1.0", "group":1},
        {"id":"github.com/spf13/cobra@v1.8.1", "group":1},
        {"id":"github.com/spf13/pflag@v1.0.6", "group":1},
        {"id":"github.com/stretchr/testify@v1.8.1", "group":1},
        {"id":"go@1.23", "group":1},
        {"id":"go.uber.org/goleak@v1.3.0", "group":1},
        {"id":"go.uber.org/multierr@v1.10.0", "group":1},
        {"id":"go.uber.org/zap@v1.27.0", "group":1},
        {"id":"golang.org/x/mod@v0.13.0", "group":1},
        {"id":"golang.org/x/tools@v0.13.0", "group":1},
        {"id":"gopkg.in/check.v1@v0.0.0-20161208181325-20d25e280405", "group":1},
        {"id":"gopkg.in/yaml.v3@v3.0.1", "group":1},
        {"id":"toolchain@go1.23", "group":1},
        {"id":"github.com/spf13/pflag@v1.0.5", "group":2},
        {"id":"github.com/stretchr/testify@v1.7.0", "group":2},
      ],
      links: [
        {"source":"github.com/AyCarlito/go-mod-visualization", "target":"github.com/inconshreveable/mousetrap@v1.1.0"},
        {"source":"github.com/AyCarlito/go-mod-visualization", "target":"github.com/spf13/cobra@v1.8.1"},
        {"source":"github.com/AyCarlito/go-mod-visualization", "target":"github.com/spf13/pflag@v1.0.6"},
        {"source":"github.com/AyCarlito/go-mod-visualization", "target":"go@1.23"},
        {"source":"github.com/AyCarlito/go-mod-visualization", "target":"go.uber.org/multierr@v1.10.0"},
        {"source":"github.com/AyCarlito/go-mod-visualization", "target":"go.uber.org/zap@v1.27.0"},
        {"source":"github.com/AyCarlito/go-mod-visualization", "target":"golang.org/x/mod@v0.13.0"},
        {"source":"github.com/spf13/cobra@v1.8.1", "target":"github.com/cpuguy83/go-md2man/v2@v2.0.4"},
        {"source":"github.com/spf13/cobra@v1.8.1", "target":"github.com/inconshreveable/mousetrap@v1.1.0"},
        {"source":"github.com/spf13/cobra@v1.8.1", "target":"github.com/spf13/pflag@v1.0.5"},
        {"source":"github.com/spf13/cobra@v1.8.1", "target":"gopkg.in/yaml.v3@v3.0.1"},
        {"source":"go@1.23", "target":"toolchain@go1.23"},
        {"source":"go.uber.org/multierr@v1.10.0", "target":"github.com/stretchr/testify@v1.7.0"},
        {"source":"go.uber.org/multierr@v1.10.0", "target":"github.com/davecgh/go-spew@v1.1.1"},
        {"source":"go.uber.org/multierr@v1.10.0", "target":"github.com/pmezard/go-difflib@v1.0.0"},
        {"source":"go.uber.org/multierr@v1.10.0", "target":"gopkg.in/yaml.v3@v3.0.1"},
        {"source":"go.uber.org/zap@v1.27.0", "target":"github.com/stretchr/testify@v1.8.1"},
        {"source":"go.uber.org/zap@v1.27.0", "target":"go.uber.org/goleak@v1.3.0"},
        {"source":"go.uber.org/zap@v1.27.0", "target":"go.uber.org/multierr@v1.10.0"},
        {"source":"go.uber.org/zap@v1.27.0", "target":"gopkg.in/yaml.v3@v3.0.1"},
        {"source":"go.uber.org/zap@v1.27.0", "target":"github.com/davecgh/go-spew@v1.1.1"},
        {"source":"go.uber.org/zap@v1.27.0", "target":"github.com/kr/text@v0.2.0"},
        {"source":"go.uber.org/zap@v1.27.0", "target":"github.com/pmezard/go-difflib@v1.0.0"},
        {"source":"golang.org/x/mod@v0.13.0", "target":"golang.org/x/tools@v0.13.0"},
        {"source":"github.com/cpuguy83/go-md2man/v2@v2.0.4", "target":"github.com/russross/blackfriday/v2@v2.1.0"},
        {"source":"gopkg.in/yaml.v3@v3.0.1", "target":"gopkg.in/check.v1@v0.0.0-20161208181325-20d25e280405"},
      ]
    };

    gData.links.forEach(link => {
      const a = gData.nodes.find(node => node.id === link.source)
      const b = gData.nodes.find(node => node.id === link.target)
      !a.neighbors && (a.neighbors = []);
      !b.neighbors && (b.neighbors = []);
      a.neighbors.push(b);
      b.neighbors.push(a);

      !a.links && (a.links = []);
      !b.links && (b.links = []);
      a.links.push(link);
      b.links.push(link);
    });


    const highlightNodes = new Set();
    const highlightLinks = new Set();
    let hoverNode = null;
    let hoverLink = null;

    const elem = document.getElementById('graph');

    const Graph = new ForceGraph(elem)
      .graphData(gData)
      .nodeId('id')
      .onNodeHover(node => {
        // Search is mutually exclusive with hover behaviour.
        if (query !== "") {
          return
        }

        highlightNodes.clear();
        highlightLinks.clear();
        if (node){
          highlightNodes.add(node);
          if (node.neighbors !== undefined){
            node.neighbors.forEach(neighbor => highlightNodes.add(neighbor));
          }
          if (node.links !== undefined){
            node.links.forEach(link => highlightLinks.add(link));
          }
        }
        hoverNode = node || null;
      })
      .nodeVisibility((node) => {
        // Show node when one of:
        // - There are no highlighted nodes.
        // - This node is a highlighted node.
        // - Any link hover.
        return (highlightNodes.size == 0 || (highlightNodes.size > 0 && highlightNodes.has(node)) || hoverLink !== null)
      })
      .onLinkHover(link => {
        // Search is mutually exclusive with hover behaviour.
        if (query !== "") {
          return
        }

        highlightNodes.clear();
        highlightLinks.clear();
        if (link) {
          highlightLinks.add(link);
          highlightNodes.add(link.source);
          highlightNodes.add(link.target);
        }
        hoverLink = link || null;
      })
      .linkVisibility((link) => {
        // Show link when one of:
        // - There are no highlighted links.
        // - This link is a highlighted link.
        // - Any link hover.
        return (highlightLinks.size == 0 || (highlightLinks.size > 0 && highlightLinks.has(link)) || hoverLink !== null)
      })
      .linkWidth(link => highlightLinks.has(link) ? 4 : 1)
      .linkDirectionalParticles(4)
      .linkDirectionalParticleWidth(link => highlightLinks.has(link) ? 4 : 0)
      .nodeCanvasObjectMode(node => highlightNodes.has(node) ? 'replace' : undefined)
      .nodeCanvasObject((node, ctx, globalScale) => {
        const label = `${node.id}`;
        const fontSize = 16 / globalScale;
        ctx.font = `bold ${fontSize}px monospace`;
        ctx.fontWeight = "900";
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = getFillStyle(node.group);
        ctx.fillText(label, node.x, node.y);

      })
      .nodeColor(node => getFillStyle(node.group));

    /**
     * Returns the canvas fill style for a node.
     *
     * @param {number} group - The group a node belongs to.
     * @returns {string} - Hexdecimal color code.
     */
    function getFillStyle(group) {
      if (group === 1) {
        return "#4F9DDE"
      }
      return "#A4A5A5"
    }

    let query = ""
    document.getElementById("searchButton").addEventListener("click", function () {
      query = document.getElementById("searchInput").value;
      highlightNodes.clear();
      highlightLinks.clear();

      const matchedNodes = gData.nodes.filter(node => node.id.includes(query))
      matchedNodes.forEach(node => {
        highlightNodes.add(node)
        if (node.neighbors !== undefined) {
          node.neighbors.forEach(neighbor => highlightNodes.add(neighbor));
        }
        if (node.links !== undefined) {
          node.links.forEach(link => highlightLinks.add(link));
        }
      })
      // If we have exactly one match from the query, centre and zoom the graph on the node.
      if(matchedNodes.length === 1) {
        Graph.centerAt(matchedNodes[0].x, matchedNodes[0].y, 500);
        Graph.zoom(4, 750);
      }
    });

    document.getElementById('resetButton').addEventListener('click', function () {
      highlightNodes.clear();
      highlightLinks.clear();
      document.getElementById('searchInput').value = "";
      query = "";
    });

  </script>
</body>